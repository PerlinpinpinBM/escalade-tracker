<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Escalade">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>Escalade v6.1.0</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:linear-gradient(135deg,#1e293b,#0f172a);color:#fff;min-height:100vh;padding:20px}
.container{max-width:500px;margin:0 auto}
.login{display:flex;align-items:center;justify-content:center;min-height:100vh}
.login-card{background:#1e293b;padding:40px;border-radius:16px;width:100%;max-width:400px;text-align:center}
.login-card h1{font-size:2rem;margin-bottom:30px}
.btn{width:100%;padding:14px;border:none;border-radius:8px;font-size:1rem;cursor:pointer;transition:all 0.3s}
.btn-google{background:#fff;color:#000;display:flex;align-items:center;justify-content:center;gap:10px}
.btn-google:active{background:#f0f0f0}
.error{background:#7f1d1d;color:#fca5a5;padding:12px;border-radius:8px;margin-bottom:20px;font-size:0.9rem}
.hidden{display:none!important}
.header{text-align:center;margin-bottom:30px}
.header h1{font-size:1.8rem;margin-bottom:5px}
.header .version{color:#94a3b8;font-size:0.8rem}
.nav{display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:30px}
.nav-btn{padding:20px;background:#1e293b;border:2px solid #334155;border-radius:12px;text-align:center;cursor:pointer;transition:all 0.3s}
.nav-btn:active{background:#334155}
.nav-btn .icon{font-size:2rem;margin-bottom:8px}
.nav-btn .label{font-size:1rem}
.card{background:#1e293b;padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid #334155}
.card h2{font-size:1.2rem;margin-bottom:15px;display:flex;justify-content:space-between;align-items:center}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}
.stat-grid-three{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:15px}
.stat{background:#334155;padding:15px;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.3s}
.stat:active{background:#475569}
.stat-label{color:#94a3b8;font-size:0.75rem;margin-bottom:5px;line-height:1.2}
.stat-value{font-size:1.5rem;font-weight:bold;color:#10b981}
.weather-card{background:#334155;padding:15px;border-radius:8px;margin-bottom:10px}
.weather-card h3{font-size:1rem;margin-bottom:10px}
.weather-days{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.weather-day{background:#1e293b;padding:10px;border-radius:6px;text-align:center}
.weather-day .day-name{color:#94a3b8;font-size:0.8rem;margin-bottom:5px}
.weather-day .icon{font-size:1.5rem;margin:5px 0}
.weather-day .temp{font-size:0.9rem}
.session-type{display:grid;grid-template-columns:1fr 1fr 1fr;gap:15px;margin-bottom:20px}
.type-card{background:#334155;padding:30px 20px;border-radius:12px;text-align:center;cursor:pointer;transition:all 0.3s}
.type-card:active{background:#475569}
.type-card .icon{font-size:3rem;margin-bottom:10px}
.type-card .label{font-size:1.1rem}
.voie-item{background:#334155;padding:15px;border-radius:8px;margin-bottom:10px}
.voie-item h4{margin-bottom:8px;font-size:1rem}
.voie-details{color:#94a3b8;font-size:0.85rem;margin-bottom:8px}
.voie-actions{display:flex;gap:8px}
.btn-small{padding:8px 12px;font-size:0.85rem;border:none;border-radius:6px;cursor:pointer}
.btn-danger{background:#ef4444;color:#fff}
.btn-edit{background:#3b82f6;color:#fff}
.btn-add{background:#10b981;color:#fff;width:100%;padding:12px;margin-top:10px;border:none;border-radius:8px;cursor:pointer}
.back-btn{background:#475569;color:#fff;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;margin-bottom:20px}
.input{width:100%;padding:10px;border:1px solid #475569;border-radius:6px;background:#0f172a;color:#fff;margin-bottom:10px;font-size:0.95rem}
select.input{-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='white' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center;background-size:20px;padding-right:35px}
.badge{display:inline-block;padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600;margin-left:8px}
.badge-projet{background:#fbbf24;color:#000}
.badge-r√©ussi{background:#10b981;color:#fff}
.badge-abandon{background:#ef4444;color:#fff}
.stars{font-size:2.5rem;margin:15px 0;cursor:pointer;user-select:none;display:flex;gap:15px;justify-content:center}
.star{display:inline-block;padding:10px;cursor:pointer;touch-action:manipulation}
.star.filled{color:#fbbf24}
.star.empty{color:#475569}
.history-item{background:#334155;padding:12px;border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all 0.3s}
.history-item:active{background:#475569}
.history-item h4{font-size:0.95rem;margin-bottom:4px}
.history-item .details{color:#94a3b8;font-size:0.8rem}
.divider{border-top:2px solid #334155;margin:25px 0;padding-top:10px}
.divider h3{color:#94a3b8;font-size:1rem;margin-bottom:15px}
.delete-session-btn{background:#ef4444;color:#fff;width:100%;padding:12px;margin-top:10px;border:none;border-radius:8px;cursor:pointer}
.user-info{text-align:center;color:#94a3b8;font-size:0.9rem;margin-bottom:20px}
.logout-btn{background:#475569;color:#fff;padding:8px 16px;border:none;border-radius:6px;font-size:0.85rem;cursor:pointer;margin-top:10px}
.form-group{margin-bottom:15px}
.form-group label{display:block;color:#94a3b8;margin-bottom:5px;font-size:0.9rem}
</style>
</head>
<body>
<div id="login-screen" class="login">
<div class="login-card">
<h1>üîí Escalade Tracker</h1>
<div id="login-error" class="error hidden"></div>
<button class="btn btn-google" id="google-signin-btn">
<svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
Se connecter avec Google
</button>
</div>
</div>
<div id="app" class="hidden">
<div class="container">
<div class="header">
<h1>‚õ∞Ô∏è Escalade Tracker</h1>
<div class="version">v6.1.0</div>
<div class="user-info" id="user-info"></div>
</div>
<div id="home-view">
<div class="nav">
<div class="nav-btn" id="board-nav">
<div class="icon">üìä</div>
<div class="label">Board</div>
</div>
<div class="nav-btn" id="session-nav">
<div class="icon">‚ûï</div>
<div class="label">Session</div>
</div>
</div>
<button class="logout-btn" id="logout-btn">D√©connexion</button>
</div>
<div id="board-view" class="hidden">
<button class="back-btn" id="board-back">‚Üê Retour</button>
<div id="board-cards-container"></div>
<div class="card">
<h2>üå§Ô∏è M√©t√©o Week-end</h2>
<div id="weather-container"></div>
</div>
</div>
<div id="session-choice-view" class="hidden">
<button class="back-btn" id="choice-back">‚Üê Retour</button>
<div class="session-type">
<div class="type-card" id="salle-btn">
<div class="icon">üè¢</div>
<div class="label">Salle</div>
</div>
<div class="type-card" id="falaise-btn">
<div class="icon">üßó</div>
<div class="label">Falaise</div>
</div>
<div class="type-card" id="viaferrata-btn">
<div class="icon">üîó</div>
<div class="label">Via Ferrata</div>
</div>
</div>
</div>
<div id="session-form-view" class="hidden">
<button class="back-btn" id="form-back">‚Üê Retour</button>
<div class="card">
<h2 id="session-title">Nouvelle Session</h2>
<label>Qui</label>
<select class="input" id="session-user">
<option value="Sophie&Bruno">Sophie&Bruno</option>
<option value="Bruno">Bruno</option>
<option value="Sophie">Sophie</option>
</select>
<div id="lieu-field" class="form-group hidden">
<label>Lieu</label>
<input class="input" id="session-lieu" placeholder="Ex: Annecy">
</div>
<label>Nom</label>
<input class="input" id="session-nom" placeholder="Nom du lieu">
<label>Date</label>
<input class="input" type="date" id="session-date">
<button class="btn btn-google" id="create-session-btn">Continuer</button>
</div>
<div class="divider">
<h3>üìã Historique</h3>
<div id="history-list"></div>
</div>
</div>
<div id="session-voies-view" class="hidden">
<button class="back-btn" id="voies-back">‚Üê Retour</button>
<div class="card">
<h2 id="session-info-title">Session</h2>
<div id="voies-list"></div>
<button class="btn-add" id="add-voie-btn">‚ûï Ajouter <span id="add-voie-label">une voie</span></button>
<button class="delete-session-btn" id="delete-session-btn">üóë Supprimer la session</button>
</div>
</div>
<div id="voie-form-view" class="hidden">
<button class="back-btn" id="voie-back">‚Üê Retour</button>
<div class="card">
<h2 id="voie-form-title">Nouvelle Voie</h2>
<input type="hidden" id="voie-edit-id">
<div id="voie-nom-field">
<label>Nom de la voie</label>
<input class="input" id="voie-nom" placeholder="Ex: La Directe">
</div>
<div id="via-lieu-field" class="hidden">
<label>Lieu</label>
<input class="input" id="via-lieu" placeholder="Ex: Annecy">
</div>
<div id="via-nom-field" class="hidden">
<label>Nom de la via</label>
<input class="input" id="via-nom" placeholder="Ex: Roc des Boeufs">
</div>
<div id="voie-niveau-field">
<label>Niveau</label>
<select class="input" id="voie-niveau">
<option>5a</option><option>5b</option><option>5c</option>
<option selected>6a</option><option>6a+</option><option>6b</option><option>6b+</option>
<option>6c</option><option>6c+</option><option>7a</option><option>7a+</option>
<option>7b</option><option>7b+</option><option>7c</option><option>7c+</option><option>8a</option>
</select>
</div>
<div id="via-difficulte-field" class="hidden">
<label>Difficult√©</label>
<select class="input" id="via-difficulte">
<option value="F">F (Facile)</option>
<option value="PD" selected>PD (Peu Difficile)</option>
<option value="AD">AD (Assez Difficile)</option>
<option value="D">D (Difficile)</option>
<option value="TD">TD (Tr√®s Difficile)</option>
<option value="ED">ED (Extr√™mement Difficile)</option>
</select>
</div>
<div id="via-approche-field" class="hidden">
<label>Approche</label>
<input class="input" id="via-approche" placeholder="Ex: 30 minutes, 1h20">
</div>
<div id="via-duree-field" class="hidden">
<label>Dur√©e</label>
<input class="input" id="via-duree" placeholder="Ex: 2h30">
</div>
<div id="via-denivele-field" class="hidden">
<label>D√©nivel√© (m)</label>
<input class="input" type="number" id="via-denivele" placeholder="Ex: 300">
</div>
<div id="voie-type-field">
<label>Type</label>
<select class="input" id="voie-type">
<option value="copyrock">CopyRock</option>
<option value="dalle">Dalle</option>
<option value="devers">Devers</option>
<option value="gros-devers">Gros Devers</option>
<option value="petit-devers">Petit Devers</option>
<option value="vertical">Vertical</option>
</select>
</div>
<div id="voie-statut-field">
<label>Statut</label>
<select class="input" id="voie-statut">
<option value="projet">Projet</option>
<option value="r√©ussi">R√©ussi</option>
<option value="abandon">Abandon</option>
</select>
</div>
<div id="voie-essais-field">
<label>Nombre d'essais</label>
<input class="input" type="number" id="voie-essais" value="1" min="1">
</div>
<label>Note (obligatoire)</label>
<div class="stars" id="star-rating"></div>
<input type="hidden" id="voie-rating" value="0">
<label>Notes</label>
<input class="input" id="voie-notes" placeholder="Optionnel">
<button class="btn btn-google" id="save-voie-btn">‚úì Enregistrer</button>
</div>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDILef-HO__QCnEJwQDNvCELmXXbF3kAfI",
  authDomain: "escalade-tracker.firebaseapp.com",
  databaseURL: "https://escalade-tracker-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "escalade-tracker",
  storageBucket: "escalade-tracker.firebasestorage.app",
  messagingSenderId: "355020489656",
  appId: "1:355020489656:web:515ba5f926045ff86f054d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);
const provider = new GoogleAuthProvider();

const ALLOWED_EMAILS = ["bruno.manuel94@gmail.com", "sof.poncet@gmail.com"];
const OPENWEATHER_API_KEY = "3c97f3998a6c30aa75a296934fc0d3f0";

let sessions = [];
let currentSession = null;
let currentType = "";
let isEditMode = false;
let currentUser = null;
let loggedUserEmail = "";

const FALAISES = [
  { name: "Saffres", lat: 47.3667, lon: 5.0167 },
  { name: "Cormot", lat: 47.0833, lon: 4.8333 },
  { name: "Annecy", lat: 45.8992, lon: 6.1294 },
  { name: "Belluno", lat: 46.1387, lon: 12.2154 }
];

function showView(viewId) {
  document.querySelectorAll('[id$="-view"]').forEach(v => v.classList.add("hidden"));
  document.getElementById(viewId).classList.remove("hidden");
}

// Google Sign-In
document.getElementById("google-signin-btn").addEventListener("click", async () => {
  try {
    const result = await signInWithPopup(auth, provider);
    const email = result.user.email;
    
    if (!ALLOWED_EMAILS.includes(email)) {
      await signOut(auth);
      document.getElementById("login-error").textContent = "Acc√®s non autoris√©";
      document.getElementById("login-error").classList.remove("hidden");
      return;
    }
    
    document.getElementById("login-error").classList.add("hidden");
  } catch (error) {
    console.error("Erreur connexion:", error);
    document.getElementById("login-error").textContent = "Erreur de connexion";
    document.getElementById("login-error").classList.remove("hidden");
  }
});

onAuthStateChanged(auth, (user) => {
  if (user && ALLOWED_EMAILS.includes(user.email)) {
    currentUser = user;
    loggedUserEmail = user.email;
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("user-info").textContent = `Connect√©: ${user.email}`;
    loadData();
  } else {
    document.getElementById("login-screen").classList.remove("hidden");
    document.getElementById("app").classList.add("hidden");
  }
});

document.getElementById("logout-btn").addEventListener("click", async () => {
  await signOut(auth);
  showView("home-view");
});

function loadData() {
  const sessionsRef = ref(db, "sessions");
  onValue(sessionsRef, (snapshot) => {
    sessions = [];
    snapshot.forEach((child) => {
      sessions.push({ id: child.key, ...child.val() });
    });
    console.log("Sessions charg√©es:", sessions.length);
  });
}

function getMaxLevel30Days(user) {
  const now = new Date();
  const thirtyDaysAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
  
  const recentSessions = sessions.filter(s => {
    if (s.type === "viaferrata") return false;
    const sessionDate = new Date(s.date);
    return s.user === user && sessionDate >= thirtyDaysAgo && sessionDate <= now;
  });
  
  let maxLevel = null;
  const levelOrder = ["5a","5b","5c","6a","6a+","6b","6b+","6c","6c+","7a","7a+","7b","7b+","7c","7c+","8a"];
  
  recentSessions.forEach(session => {
    session.voies.forEach(voie => {
      if (voie.statut === "r√©ussi") {
        const currentIndex = levelOrder.indexOf(voie.niveau);
        const maxIndex = maxLevel ? levelOrder.indexOf(maxLevel) : -1;
        if (currentIndex > maxIndex) {
          maxLevel = voie.niveau;
        }
      }
    });
  });
  
  return maxLevel || "-";
}

function updateBoard() {
  const container = document.getElementById("board-cards-container");
  
  // D√©terminer l'ordre bas√© sur l'utilisateur connect√©
  const users = loggedUserEmail === "bruno.manuel94@gmail.com" 
    ? ["Bruno", "Sophie"] 
    : ["Sophie", "Bruno"];
  
  let html = "";
  
  users.forEach(user => {
    const maxLevel = getMaxLevel30Days(user);
    const salleSessions = sessions.filter(s => s.user && s.user === user && s.type === "salle").length;
    const falaiseSessions = sessions.filter(s => s.user && s.user === user && s.type === "falaise").length;
    // Pour via ferrata, on compte celles qui contiennent le nom de l'user dans le champ user
    const viaFerratas = sessions.filter(s => s.user && s.type === "viaferrata" && s.user.includes(user)).length;
    
    html += `<div class="card">
      <h2>üìä ${user}</h2>
      <div class="stat-grid">
        <div class="stat"><div class="stat-label">Niveau Max<br>30 jours</div><div class="stat-value">${maxLevel}</div></div>
        <div class="stat" data-user="${user}" data-type="salle"><div class="stat-label">Sessions<br>salle</div><div class="stat-value">${salleSessions}</div></div>
      </div>
      <div class="stat-grid">
        <div class="stat" data-user="${user}" data-type="falaise"><div class="stat-label">Sessions<br>falaise</div><div class="stat-value">${falaiseSessions}</div></div>
        <div class="stat" data-user="${user}" data-type="viaferrata"><div class="stat-label">Via<br>Ferrata</div><div class="stat-value">${viaFerratas}</div></div>
      </div>
    </div>`;
  });
  
  container.innerHTML = html;
  
  // Ajouter les event listeners pour les stats cliquables
  document.querySelectorAll('.stat[data-type]').forEach(stat => {
    stat.addEventListener('click', () => {
      const type = stat.dataset.type;
      currentType = type;
      isEditMode = false;
      
      if (type === "salle") {
        document.getElementById("session-title").textContent = "Nouvelle Session üè¢";
        document.getElementById("session-nom").value = "Nautil";
        document.getElementById("session-user").value = "Bruno";
        document.getElementById("lieu-field").classList.add("hidden");
      } else if (type === "falaise") {
        document.getElementById("session-title").textContent = "Nouvelle Session üßó";
        document.getElementById("session-nom").value = "";
        document.getElementById("session-user").value = "Bruno";
        document.getElementById("lieu-field").classList.add("hidden");
      } else if (type === "viaferrata") {
        document.getElementById("session-title").textContent = "Nouvelle Via Ferrata üîó";
        document.getElementById("session-user").value = "Sophie&Bruno";
        document.getElementById("session-nom").value = "";
        document.getElementById("lieu-field").classList.remove("hidden");
      }
      
      document.getElementById("session-date").value = new Date().toISOString().split("T")[0];
      showView("session-form-view");
      renderHistory();
    });
  });
}

async function loadWeather() {
  const container = document.getElementById("weather-container");
  container.innerHTML = "<p style='color:#94a3b8'>Chargement m√©t√©o...</p>";
  
  try {
    const weatherPromises = FALAISES.map(async (falaise) => {
      const url = `https://api.openweathermap.org/data/2.5/forecast?lat=${falaise.lat}&lon=${falaise.lon}&appid=${OPENWEATHER_API_KEY}&units=metric&lang=fr`;
      const response = await fetch(url);
      const data = await response.json();
      
      const now = new Date();
      const currentDay = now.getDay();
      
      let daysUntilSaturday = (6 - currentDay + 7) % 7;
      if (daysUntilSaturday === 0 && now.getHours() >= 12) daysUntilSaturday = 7;
      
      const nextSaturday = new Date(now);
      nextSaturday.setDate(now.getDate() + daysUntilSaturday);
      nextSaturday.setHours(12, 0, 0, 0);
      
      const nextSunday = new Date(nextSaturday);
      nextSunday.setDate(nextSaturday.getDate() + 1);
      
      let satForecast = null;
      let sunForecast = null;
      let minSatDiff = Infinity;
      let minSunDiff = Infinity;
      
      data.list.forEach(forecast => {
        const forecastDate = new Date(forecast.dt * 1000);
        const satDiff = Math.abs(forecastDate - nextSaturday);
        const sunDiff = Math.abs(forecastDate - nextSunday);
        
        if (satDiff < minSatDiff) {
          minSatDiff = satDiff;
          satForecast = forecast;
        }
        if (sunDiff < minSunDiff) {
          minSunDiff = sunDiff;
          sunForecast = forecast;
        }
      });
      
      if (!satForecast || !sunForecast) {
        return `<div class="weather-card"><h3>${falaise.name}</h3><p style="color:#94a3b8">Donn√©es indisponibles</p></div>`;
      }
      
      const getIcon = (weather) => {
        const main = weather.weather[0].main.toLowerCase();
        if (main.includes("clear")) return "‚òÄÔ∏è";
        if (main.includes("cloud")) return "‚òÅÔ∏è";
        if (main.includes("rain")) return "üåßÔ∏è";
        if (main.includes("snow")) return "üå®Ô∏è";
        if (main.includes("thunder")) return "‚õàÔ∏è";
        return "‚õÖ";
      };
      
      return `<div class="weather-card">
        <h3>${falaise.name}</h3>
        <div class="weather-days">
          <div class="weather-day">
            <div class="day-name">Samedi</div>
            <div class="icon">${getIcon(satForecast)}</div>
            <div class="temp">${Math.round(satForecast.main.temp)}¬∞C</div>
          </div>
          <div class="weather-day">
            <div class="day-name">Dimanche</div>
            <div class="icon">${getIcon(sunForecast)}</div>
            <div class="temp">${Math.round(sunForecast.main.temp)}¬∞C</div>
          </div>
        </div>
      </div>`;
    });
    
    const results = await Promise.all(weatherPromises);
    container.innerHTML = results.join("");
  } catch (error) {
    console.error("Erreur m√©t√©o:", error);
    container.innerHTML = "<p style='color:#ef4444'>Erreur de chargement m√©t√©o</p>";
  }
}

function renderHistory() {
  const list = document.getElementById("history-list");
  const filtered = sessions.filter(s => s.type === currentType).sort((a, b) => new Date(b.date) - new Date(a.date));
  
  if (filtered.length === 0) {
    list.innerHTML = '<p style="color:#94a3b8;text-align:center">Aucun historique</p>';
    return;
  }
  
  list.innerHTML = filtered.map(s => {
    let displayText = "";
    if (s.type === "viaferrata") {
      displayText = `${s.lieu} - ${s.nom} - ${s.date}`;
    } else {
      displayText = `${s.nom} - ${s.date}`;
    }
    const itemCount = s.type === "viaferrata" ? "1 via" : `${s.voies.length} voie(s)`;
    
    return `<div class="history-item" data-session-id="${s.id}">
      <h4>${displayText}</h4>
      <div class="details">${s.user} ‚Ä¢ ${itemCount}</div>
    </div>`;
  }).join("");
  
  document.querySelectorAll('.history-item').forEach(el => {
    el.addEventListener('click', () => {
      const session = sessions.find(s => s.id == el.dataset.sessionId);
      currentSession = { ...session };
      isEditMode = true;
      
      if (session.type === "viaferrata") {
        document.getElementById("session-info-title").textContent = session.lieu + " - " + session.nom + " - " + session.date;
      } else {
        document.getElementById("session-info-title").textContent = session.nom + " - " + session.date;
      }
      
      showView("session-voies-view");
      renderVoies();
    });
  });
}

function renderVoies() {
  const list = document.getElementById("voies-list");
  const addLabel = document.getElementById("add-voie-label");
  
  if (currentType === "viaferrata") {
    addLabel.textContent = "une via";
  } else {
    addLabel.textContent = "une voie";
  }
  
  if (currentSession.voies.length === 0) {
    list.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:20px">Aucune voie</p>';
    return;
  }
  
  list.innerHTML = currentSession.voies.map((v, i) => {
    let title, details, stars;
    
    if (currentType === "viaferrata") {
      title = "Via Ferrata";
      const maxStars = 5;
      stars = "‚≠ê".repeat(v.rating || 0) + "‚òÜ".repeat(maxStars - (v.rating || 0));
      details = `${v.difficulte} ‚Ä¢ Approche: ${v.approche} ‚Ä¢ Dur√©e: ${v.duree} ‚Ä¢ ${v.denivele}m${v.notes ? " ‚Ä¢ " + v.notes : ""}`;
    } else {
      title = currentType === "salle" ? `Voie ${i + 1}` : v.nom;
      const maxStars = 3;
      stars = "‚≠ê".repeat(v.rating || 0) + "‚òÜ".repeat(maxStars - (v.rating || 0));
      details = `${v.niveau} ‚Ä¢ ${v.type} ‚Ä¢ ${v.essais} essai(s)${v.notes ? " ‚Ä¢ " + v.notes : ""}`;
    }
    
    const badge = currentType === "viaferrata" ? "" : `<span class="badge badge-${v.statut}">${v.statut}</span>`;
    
    return `<div class="voie-item">
      <h4>${title} ${badge}</h4>
      <div class="stars">${stars}</div>
      <div class="voie-details">${details}</div>
      <div class="voie-actions">
        <button class="btn-small btn-edit" data-voie-id="${v.id}">‚úèÔ∏è</button>
        <button class="btn-small btn-danger" data-delete-voie="${v.id}">üóë</button>
      </div>
    </div>`;
  }).join("");
  
  document.querySelectorAll('[data-voie-id]').forEach(el => {
    el.addEventListener('click', () => {
      const voie = currentSession.voies.find(v => v.id == el.dataset.voieId);
      document.getElementById("voie-form-title").textContent = "Modifier";
      document.getElementById("voie-edit-id").value = voie.id;
      
      if (currentType === "viaferrata") {
        // Via Ferrata
        document.getElementById("via-lieu-field").classList.remove("hidden");
        document.getElementById("via-nom-field").classList.remove("hidden");
        document.getElementById("via-difficulte-field").classList.remove("hidden");
        document.getElementById("via-approche-field").classList.remove("hidden");
        document.getElementById("via-duree-field").classList.remove("hidden");
        document.getElementById("via-denivele-field").classList.remove("hidden");
        
        document.getElementById("voie-nom-field").classList.add("hidden");
        document.getElementById("voie-niveau-field").classList.add("hidden");
        document.getElementById("voie-type-field").classList.add("hidden");
        document.getElementById("voie-statut-field").classList.add("hidden");
        document.getElementById("voie-essais-field").classList.add("hidden");
        
        document.getElementById("via-lieu").value = voie.lieu;
        document.getElementById("via-nom").value = voie.nom;
        document.getElementById("via-difficulte").value = voie.difficulte;
        document.getElementById("via-approche").value = voie.approche;
        document.getElementById("via-duree").value = voie.duree;
        document.getElementById("via-denivele").value = voie.denivele;
        
        updateStarDisplay(voie.rating || 0, 5);
      } else {
        // Salle ou Falaise
        document.getElementById("via-lieu-field").classList.add("hidden");
        document.getElementById("via-nom-field").classList.add("hidden");
        document.getElementById("via-difficulte-field").classList.add("hidden");
        document.getElementById("via-approche-field").classList.add("hidden");
        document.getElementById("via-duree-field").classList.add("hidden");
        document.getElementById("via-denivele-field").classList.add("hidden");
        
        document.getElementById("voie-niveau-field").classList.remove("hidden");
        document.getElementById("voie-type-field").classList.remove("hidden");
        document.getElementById("voie-statut-field").classList.remove("hidden");
        document.getElementById("voie-essais-field").classList.remove("hidden");
        
        if (currentType === "falaise") {
          document.getElementById("voie-nom-field").classList.remove("hidden");
          document.getElementById("voie-nom").value = voie.nom;
        } else {
          document.getElementById("voie-nom-field").classList.add("hidden");
        }
        
        document.getElementById("voie-niveau").value = voie.niveau;
        document.getElementById("voie-type").value = voie.type;
        document.getElementById("voie-statut").value = voie.statut;
        document.getElementById("voie-essais").value = voie.essais;
        
        updateStarDisplay(voie.rating || 0, 3);
      }
      
      document.getElementById("voie-rating").value = voie.rating || 0;
      document.getElementById("voie-notes").value = voie.notes;
      showView("voie-form-view");
    });
  });
  
  document.querySelectorAll('[data-delete-voie]').forEach(el => {
    el.addEventListener('click', () => {
      if (confirm("Supprimer ?")) {
        currentSession.voies = currentSession.voies.filter(v => v.id != el.dataset.deleteVoie);
        renderVoies();
      }
    });
  });
}

function updateStarDisplay(rating, maxStars = 3) {
  const container = document.getElementById("star-rating");
  container.innerHTML = '';
  
  for (let i = 1; i <= maxStars; i++) {
    const star = document.createElement('span');
    star.className = 'star ' + (i <= rating ? 'filled' : 'empty');
    star.textContent = i <= rating ? '‚≠ê' : '‚òÜ';
    star.addEventListener('click', () => {
      const currentRating = parseInt(document.getElementById("voie-rating").value);
      const newRating = (i === currentRating) ? i - 1 : i;
      document.getElementById("voie-rating").value = newRating;
      updateStarDisplay(newRating, maxStars);
    });
    container.appendChild(star);
  }
}

// Navigation
document.getElementById("board-nav").addEventListener('click', () => {
  showView("board-view");
  updateBoard();
  loadWeather();
});

document.getElementById("session-nav").addEventListener('click', () => {
  showView("session-choice-view");
});

document.getElementById("board-back").addEventListener('click', () => {
  showView("home-view");
});

document.getElementById("choice-back").addEventListener('click', () => {
  showView("home-view");
});

// Session type choice
document.getElementById("salle-btn").addEventListener('click', () => {
  currentType = "salle";
  isEditMode = false;
  document.getElementById("session-title").textContent = "Nouvelle Session üè¢";
  document.getElementById("session-user").value = "Bruno";
  document.getElementById("session-nom").value = "Nautil";
  document.getElementById("session-date").value = new Date().toISOString().split("T")[0];
  document.getElementById("lieu-field").classList.add("hidden");
  showView("session-form-view");
  renderHistory();
});

document.getElementById("falaise-btn").addEventListener('click', () => {
  currentType = "falaise";
  isEditMode = false;
  document.getElementById("session-title").textContent = "Nouvelle Session üßó";
  document.getElementById("session-user").value = "Bruno";
  document.getElementById("session-nom").value = "";
  document.getElementById("session-date").value = new Date().toISOString().split("T")[0];
  document.getElementById("lieu-field").classList.add("hidden");
  showView("session-form-view");
  renderHistory();
});

document.getElementById("viaferrata-btn").addEventListener('click', () => {
  currentType = "viaferrata";
  isEditMode = false;
  document.getElementById("session-title").textContent = "Nouvelle Via Ferrata üîó";
  document.getElementById("session-user").value = "Sophie&Bruno";
  document.getElementById("session-nom").value = "";
  document.getElementById("session-date").value = new Date().toISOString().split("T")[0];
  document.getElementById("lieu-field").classList.remove("hidden");
  showView("session-form-view");
  renderHistory();
});

document.getElementById("form-back").addEventListener('click', () => {
  showView("session-choice-view");
});

// Create session
document.getElementById("create-session-btn").addEventListener('click', () => {
  const user = document.getElementById("session-user").value;
  const nom = document.getElementById("session-nom").value;
  const date = document.getElementById("session-date").value;
  
  if (!nom || !date) {
    alert("Remplis tous les champs");
    return;
  }
  
  currentSession = {
    id: Date.now(),
    type: currentType,
    user: user,
    nom: nom,
    date: date,
    voies: []
  };
  
  if (currentType === "viaferrata") {
    const lieu = document.getElementById("session-lieu").value;
    if (!lieu) {
      alert("Le lieu est obligatoire pour les via ferratas");
      return;
    }
    currentSession.lieu = lieu;
    document.getElementById("session-info-title").textContent = lieu + " - " + nom + " - " + date;
  } else {
    document.getElementById("session-info-title").textContent = nom + " - " + date;
  }
  
  isEditMode = false;
  showView("session-voies-view");
  renderVoies();
});

// Add voie
document.getElementById("add-voie-btn").addEventListener('click', () => {
  document.getElementById("voie-form-title").textContent = currentType === "viaferrata" ? "Nouvelle Via" : "Nouvelle Voie";
  document.getElementById("voie-edit-id").value = "";
  
  if (currentType === "viaferrata") {
    // Via Ferrata
    document.getElementById("via-lieu-field").classList.remove("hidden");
    document.getElementById("via-nom-field").classList.remove("hidden");
    document.getElementById("via-difficulte-field").classList.remove("hidden");
    document.getElementById("via-approche-field").classList.remove("hidden");
    document.getElementById("via-duree-field").classList.remove("hidden");
    document.getElementById("via-denivele-field").classList.remove("hidden");
    
    document.getElementById("voie-nom-field").classList.add("hidden");
    document.getElementById("voie-niveau-field").classList.add("hidden");
    document.getElementById("voie-type-field").classList.add("hidden");
    document.getElementById("voie-statut-field").classList.add("hidden");
    document.getElementById("voie-essais-field").classList.add("hidden");
    
    document.getElementById("via-lieu").value = "";
    document.getElementById("via-nom").value = "";
    document.getElementById("via-difficulte").value = "PD";
    document.getElementById("via-approche").value = "";
    document.getElementById("via-duree").value = "";
    document.getElementById("via-denivele").value = "";
    
    updateStarDisplay(0, 5);
  } else {
    // Salle ou Falaise
    document.getElementById("via-lieu-field").classList.add("hidden");
    document.getElementById("via-nom-field").classList.add("hidden");
    document.getElementById("via-difficulte-field").classList.add("hidden");
    document.getElementById("via-approche-field").classList.add("hidden");
    document.getElementById("via-duree-field").classList.add("hidden");
    document.getElementById("via-denivele-field").classList.add("hidden");
    
    document.getElementById("voie-niveau-field").classList.remove("hidden");
    document.getElementById("voie-type-field").classList.remove("hidden");
    document.getElementById("voie-statut-field").classList.remove("hidden");
    document.getElementById("voie-essais-field").classList.remove("hidden");
    
    if (currentType === "salle") {
      document.getElementById("voie-nom-field").classList.add("hidden");
    } else {
      document.getElementById("voie-nom-field").classList.remove("hidden");
      document.getElementById("voie-nom").value = "";
    }
    
    document.getElementById("voie-niveau").value = "6a";
    document.getElementById("voie-type").value = "copyrock";
    document.getElementById("voie-statut").value = "projet";
    document.getElementById("voie-essais").value = "1";
    
    updateStarDisplay(0, 3);
  }
  
  document.getElementById("voie-rating").value = "0";
  document.getElementById("voie-notes").value = "";
  showView("voie-form-view");
});

// Save session and go back
document.getElementById("voies-back").addEventListener('click', async () => {
  await set(ref(db, "sessions/" + currentSession.id), currentSession);
  currentSession = null;
  showView("session-form-view");
  renderHistory();
});

// Delete session
document.getElementById("delete-session-btn").addEventListener('click', async () => {
  if (confirm("Supprimer cette session ?")) {
    await remove(ref(db, "sessions/" + currentSession.id));
    currentSession = null;
    showView("session-form-view");
    renderHistory();
  }
});

document.getElementById("voie-back").addEventListener('click', () => {
  showView("session-voies-view");
});

// Save voie
document.getElementById("save-voie-btn").addEventListener('click', () => {
  const id = document.getElementById("voie-edit-id").value;
  const rating = parseInt(document.getElementById("voie-rating").value);
  const maxStars = currentType === "viaferrata" ? 5 : 3;
  
  if (rating === 0) {
    alert(`Note obligatoire (1-${maxStars} √©toiles)`);
    return;
  }
  
  let voie = {
    rating: rating,
    notes: document.getElementById("voie-notes").value
  };
  
  if (currentType === "viaferrata") {
    voie.lieu = document.getElementById("via-lieu").value;
    voie.nom = document.getElementById("via-nom").value;
    voie.difficulte = document.getElementById("via-difficulte").value;
    voie.approche = document.getElementById("via-approche").value;
    voie.duree = document.getElementById("via-duree").value;
    voie.denivele = parseInt(document.getElementById("via-denivele").value) || 0;
    
    if (!voie.lieu || !voie.nom || !voie.approche || !voie.duree) {
      alert("Tous les champs sont requis pour les via ferratas");
      return;
    }
  } else {
    voie.niveau = document.getElementById("voie-niveau").value;
    voie.type = document.getElementById("voie-type").value;
    voie.statut = document.getElementById("voie-statut").value;
    voie.essais = parseInt(document.getElementById("voie-essais").value);
    
    if (currentType === "falaise") {
      voie.nom = document.getElementById("voie-nom").value;
      if (!voie.nom) {
        alert("Nom de voie requis pour les falaises");
        return;
      }
    }
  }
  
  if (id) {
    const idx = currentSession.voies.findIndex(v => v.id == id);
    currentSession.voies[idx] = { ...voie, id: id };
  } else {
    currentSession.voies.push({ ...voie, id: Date.now() });
  }
  
  showView("session-voies-view");
  renderVoies();
});

</script>
</body>
</html>
