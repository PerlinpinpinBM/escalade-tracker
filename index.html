<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Escalade">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<title>Escalade v7.0.0</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-primary:#0a0e14;
  --bg-secondary:#151922;
  --bg-tertiary:#1f2633;
  --accent-primary:#00d9ff;
  --accent-secondary:#7b61ff;
  --accent-success:#00ff9d;
  --accent-warning:#ffb800;
  --accent-danger:#ff3366;
  --text-primary:#e8eaed;
  --text-secondary:#9ca3af;
  --text-tertiary:#6b7280;
  --border-color:#2d3748;
  --shadow:0 8px 32px rgba(0,0,0,0.4);
}
body{
  font-family:'Outfit',sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  min-height:100vh;
  padding:20px;
  background-image:
    radial-gradient(circle at 20% 50%, rgba(123,97,255,0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(0,217,255,0.06) 0%, transparent 50%);
}
.container{max-width:600px;margin:0 auto}

/* Login */
.login{display:flex;align-items:center;justify-content:center;min-height:100vh}
.login-card{
  background:var(--bg-secondary);
  padding:50px 40px;
  border-radius:24px;
  width:100%;
  max-width:420px;
  text-align:center;
  border:1px solid var(--border-color);
  box-shadow:var(--shadow);
}
.login-card h1{
  font-size:2.5rem;
  margin-bottom:40px;
  background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  font-weight:700;
}
.btn{
  width:100%;
  padding:16px;
  border:none;
  border-radius:12px;
  font-size:1rem;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s;
  font-family:'Outfit',sans-serif;
}
.btn-google{
  background:#fff;
  color:#000;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
}
.btn-google:active{transform:scale(0.98)}
.error{
  background:var(--accent-danger);
  color:#fff;
  padding:14px;
  border-radius:10px;
  margin-bottom:20px;
  font-size:0.9rem;
}
.hidden{display:none!important}

/* Header */
.header{
  text-align:center;
  margin-bottom:40px;
  animation:fadeInDown 0.6s ease;
}
.header h1{
  font-size:2.2rem;
  margin-bottom:8px;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}
.header .version{
  color:var(--text-tertiary);
  font-size:0.85rem;
  font-family:'JetBrains Mono',monospace;
}
.user-info{
  text-align:center;
  color:var(--text-secondary);
  font-size:0.9rem;
  margin-bottom:20px;
}

/* Navigation */
.nav{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
  margin-bottom:40px;
  animation:fadeInUp 0.6s ease 0.2s backwards;
}
.nav-btn{
  padding:40px 30px;
  background:var(--bg-secondary);
  border:2px solid var(--border-color);
  border-radius:20px;
  text-align:center;
  cursor:pointer;
  transition:all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  position:relative;
  overflow:hidden;
}
.nav-btn::before{
  content:'';
  position:absolute;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  opacity:0;
  transition:opacity 0.4s;
  z-index:0;
}
.nav-btn:hover::before{opacity:0.1}
.nav-btn:active{transform:scale(0.96)}
.nav-btn .icon{
  font-size:3rem;
  margin-bottom:12px;
  position:relative;
  z-index:1;
}
.nav-btn .label{
  font-size:1.1rem;
  font-weight:600;
  position:relative;
  z-index:1;
}

/* Cards */
.card{
  background:var(--bg-secondary);
  padding:28px;
  border-radius:20px;
  margin-bottom:24px;
  border:1px solid var(--border-color);
  box-shadow:var(--shadow);
  animation:fadeInUp 0.5s ease backwards;
}
.card h2{
  font-size:1.4rem;
  margin-bottom:20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-weight:700;
  color:var(--accent-primary);
}

/* Stats Grid */
.stat-grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-bottom:20px;
}
.stat{
  background:var(--bg-tertiary);
  padding:20px;
  border-radius:14px;
  text-align:center;
  cursor:pointer;
  transition:all 0.3s;
  border:1px solid transparent;
}
.stat:hover{
  border-color:var(--accent-primary);
  transform:translateY(-2px);
}
.stat:active{transform:scale(0.96)}
.stat-label{
  color:var(--text-secondary);
  font-size:0.8rem;
  margin-bottom:8px;
  font-weight:500;
}
.stat-value{
  font-size:2rem;
  font-weight:700;
  background:linear-gradient(135deg, var(--accent-success), var(--accent-primary));
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
}

/* Buttons */
.back-btn{
  background:var(--bg-tertiary);
  color:var(--text-primary);
  padding:12px 24px;
  border:1px solid var(--border-color);
  border-radius:12px;
  cursor:pointer;
  margin-bottom:24px;
  font-size:0.95rem;
  font-weight:600;
  transition:all 0.3s;
  font-family:'Outfit',sans-serif;
}
.back-btn:hover{border-color:var(--accent-primary)}
.back-btn:active{transform:scale(0.96)}

.btn-primary{
  background:linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  color:#fff;
}
.btn-success{
  background:var(--accent-success);
  color:var(--bg-primary);
}
.btn-danger{
  background:var(--accent-danger);
  color:#fff;
}
.btn-secondary{
  background:var(--bg-tertiary);
  color:var(--text-primary);
  border:1px solid var(--border-color);
}

.btn-add{
  width:100%;
  padding:16px;
  margin-top:16px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-size:1rem;
  font-weight:600;
  font-family:'Outfit',sans-serif;
}

.btn-small{
  padding:10px 16px;
  font-size:0.9rem;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  font-family:'Outfit',sans-serif;
  transition:all 0.3s;
}
.btn-small:active{transform:scale(0.94)}

/* Forms */
.form-group{margin-bottom:18px}
.form-group label{
  display:block;
  color:var(--text-secondary);
  margin-bottom:8px;
  font-size:0.9rem;
  font-weight:600;
}
.input{
  width:100%;
  padding:14px;
  border:1px solid var(--border-color);
  border-radius:10px;
  background:var(--bg-tertiary);
  color:var(--text-primary);
  font-size:1rem;
  font-family:'Outfit',sans-serif;
  transition:all 0.3s;
}
.input:focus{
  outline:none;
  border-color:var(--accent-primary);
  box-shadow:0 0 0 3px rgba(0,217,255,0.1);
}
select.input{
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23e8eaed' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 12px center;
  background-size:24px;
  padding-right:45px;
}
textarea.input{
  min-height:100px;
  resize:vertical;
}

/* Liste items */
.lieu-item, .voie-item, .tentative-item{
  background:var(--bg-tertiary);
  padding:18px;
  border-radius:12px;
  margin-bottom:12px;
  cursor:pointer;
  transition:all 0.3s;
  border:1px solid transparent;
  animation:fadeInUp 0.4s ease backwards;
}
.lieu-item:hover, .voie-item:hover, .tentative-item:hover{
  border-color:var(--accent-primary);
  transform:translateX(4px);
}
.lieu-item:active, .voie-item:active, .tentative-item:active{
  transform:scale(0.98);
}
.lieu-item h3, .voie-item h4, .tentative-item h4{
  font-size:1.1rem;
  margin-bottom:8px;
  font-weight:600;
}
.lieu-stats, .voie-details, .tentative-details{
  color:var(--text-secondary);
  font-size:0.85rem;
  margin-bottom:10px;
  font-family:'JetBrains Mono',monospace;
}
.item-actions{
  display:flex;
  gap:10px;
  margin-top:12px;
}

/* Badges */
.badge{
  display:inline-block;
  padding:5px 12px;
  border-radius:6px;
  font-size:0.75rem;
  font-weight:700;
  margin-left:8px;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.badge-a-essayer{background:#6b7280;color:#fff}
.badge-projet{background:var(--accent-warning);color:var(--bg-primary)}
.badge-enchainee{background:var(--accent-success);color:var(--bg-primary)}
.badge-abandonnee{background:var(--accent-danger);color:#fff}

.badge-reussi{background:var(--accent-success);color:var(--bg-primary)}
.badge-avue{background:#00d9ff;color:var(--bg-primary)}
.badge-travail{background:var(--accent-warning);color:var(--bg-primary)}
.badge-echec{background:var(--accent-danger);color:#fff}

/* Stars */
.stars{
  font-size:2.8rem;
  margin:20px 0;
  cursor:pointer;
  user-select:none;
  display:flex;
  gap:20px;
  justify-content:center;
}
.star{
  display:inline-block;
  padding:12px;
  cursor:pointer;
  touch-action:manipulation;
  transition:all 0.3s;
}
.star:active{transform:scale(1.2)}
.star.filled{color:var(--accent-warning);filter:drop-shadow(0 0 8px rgba(255,184,0,0.5))}
.star.empty{color:var(--text-tertiary)}

/* Logout */
.logout-btn{
  background:var(--bg-tertiary);
  color:var(--text-secondary);
  padding:10px 20px;
  border:1px solid var(--border-color);
  border-radius:10px;
  font-size:0.9rem;
  cursor:pointer;
  margin-top:12px;
  font-family:'Outfit',sans-serif;
  font-weight:600;
  transition:all 0.3s;
}
.logout-btn:hover{
  border-color:var(--accent-danger);
  color:var(--accent-danger);
}

/* Animations */
@keyframes fadeInUp{
  from{opacity:0;transform:translateY(20px)}
  to{opacity:1;transform:translateY(0)}
}
@keyframes fadeInDown{
  from{opacity:0;transform:translateY(-20px)}
  to{opacity:1;transform:translateY(0)}
}

/* Empty state */
.empty-state{
  text-align:center;
  padding:60px 20px;
  color:var(--text-tertiary);
}
.empty-state .icon{font-size:4rem;margin-bottom:16px;opacity:0.5}
.empty-state p{font-size:1rem}

/* Delete button in forms */
.delete-btn{
  background:var(--accent-danger);
  color:#fff;
  width:100%;
  padding:14px;
  margin-top:20px;
  border:none;
  border-radius:12px;
  cursor:pointer;
  font-size:1rem;
  font-weight:600;
  font-family:'Outfit',sans-serif;
}

/* Scrollbar */
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:var(--bg-primary)}
::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:var(--accent-primary)}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen" class="login">
  <div class="login-card">
    <h1>‚õ∞Ô∏è Escalade</h1>
    <div id="login-error" class="error hidden"></div>
    <button class="btn btn-google" id="google-signin-btn">
      <svg width="20" height="20" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Se connecter avec Google
    </button>
  </div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="container">
    
    <!-- HEADER -->
    <div class="header">
      <h1>‚õ∞Ô∏è Escalade Tracker</h1>
      <div class="version">v7.0.0</div>
      <div class="user-info" id="user-info"></div>
    </div>

    <!-- HOME VIEW -->
    <div id="home-view">
      <div class="nav">
        <div class="nav-btn" id="board-nav">
          <div class="icon">üìä</div>
          <div class="label">Board</div>
        </div>
        <div class="nav-btn" id="falaise-nav">
          <div class="icon">üßó</div>
          <div class="label">Falaise</div>
        </div>
      </div>
      <button class="logout-btn" id="logout-btn">D√©connexion</button>
    </div>

    <!-- BOARD VIEW -->
    <div id="board-view" class="hidden">
      <button class="back-btn" id="board-back">‚Üê Retour</button>
      <div class="card">
        <h2>üìä Statistiques Falaise</h2>
        <div class="stat-grid">
          <div class="stat">
            <div class="stat-label">Lieux visit√©s</div>
            <div class="stat-value" id="stat-lieux">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Total voies</div>
            <div class="stat-value" id="stat-voies">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Voies encha√Æn√©es</div>
            <div class="stat-value" id="stat-enchaines">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">Projets en cours</div>
            <div class="stat-value" id="stat-projets">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- FALAISE: LISTE DES LIEUX -->
    <div id="lieux-view" class="hidden">
      <button class="back-btn" id="lieux-back">‚Üê Retour</button>
      <div class="card">
        <h2>üßó Mes Lieux d'Escalade</h2>
        <div id="lieux-list"></div>
        <button class="btn btn-add btn-success" id="add-lieu-btn">‚ûï Ajouter un lieu</button>
      </div>
    </div>

    <!-- FALAISE: FORMULAIRE LIEU -->
    <div id="lieu-form-view" class="hidden">
      <button class="back-btn" id="lieu-form-back">‚Üê Retour</button>
      <div class="card">
        <h2 id="lieu-form-title">Nouveau Lieu</h2>
        <input type="hidden" id="lieu-edit-id">
        <div class="form-group">
          <label>Nom du lieu</label>
          <input class="input" id="lieu-nom" placeholder="Ex: Saffres, Fontainebleau...">
        </div>
        <div class="form-group">
          <label>R√©gion / D√©partement (optionnel)</label>
          <input class="input" id="lieu-region" placeholder="Ex: Seine-et-Marne, 77">
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea class="input" id="lieu-notes" placeholder="Acc√®s, parking, particularit√©s..."></textarea>
        </div>
        <button class="btn btn-add btn-success" id="save-lieu-btn">üíæ Enregistrer</button>
        <button class="btn delete-btn hidden" id="delete-lieu-btn">üóë Supprimer ce lieu</button>
      </div>
    </div>

    <!-- FALAISE: LISTE DES VOIES -->
    <div id="voies-view" class="hidden">
      <button class="back-btn" id="voies-back">‚Üê Retour aux lieux</button>
      <div class="card">
        <h2 id="voies-title">Voies</h2>
        <div id="voies-list"></div>
        <button class="btn btn-add btn-success" id="add-voie-btn">‚ûï Ajouter une voie</button>
      </div>
    </div>

    <!-- FALAISE: FORMULAIRE VOIE -->
    <div id="voie-form-view" class="hidden">
      <button class="back-btn" id="voie-form-back">‚Üê Retour</button>
      <div class="card">
        <h2 id="voie-form-title">Nouvelle Voie</h2>
        <input type="hidden" id="voie-edit-id">
        <div class="form-group">
          <label>Nom de la voie</label>
          <input class="input" id="voie-nom" placeholder="Ex: La Directe">
        </div>
        <div class="form-group">
          <label>Cotation</label>
          <select class="input" id="voie-cotation">
            <option value="3">3</option>
            <option value="4a">4a</option>
            <option value="4b">4b</option>
            <option value="4c">4c</option>
            <option value="5a">5a</option>
            <option value="5b">5b</option>
            <option value="5c">5c</option>
            <option value="6a" selected>6a</option>
            <option value="6a+">6a+</option>
            <option value="6b">6b</option>
            <option value="6b+">6b+</option>
            <option value="6c">6c</option>
            <option value="6c+">6c+</option>
            <option value="7a">7a</option>
            <option value="7a+">7a+</option>
            <option value="7b">7b</option>
            <option value="7b+">7b+</option>
            <option value="7c">7c</option>
            <option value="7c+">7c+</option>
            <option value="8a">8a</option>
            <option value="8a+">8a+</option>
            <option value="8b">8b</option>
            <option value="8b+">8b+</option>
            <option value="8c">8c</option>
            <option value="8c+">8c+</option>
            <option value="9a">9a</option>
          </select>
        </div>
        <div class="form-group">
          <label>Type de voie</label>
          <select class="input" id="voie-type">
            <option value="dalle">Dalle</option>
            <option value="vertical">Vertical</option>
            <option value="devers">D√©vers</option>
            <option value="toit">Toit</option>
            <option value="mixte">Mixte</option>
          </select>
        </div>
        <div class="form-group">
          <label>Secteur (optionnel)</label>
          <input class="input" id="voie-secteur" placeholder="Ex: Secteur Rouge">
        </div>
        <div class="form-group">
          <label>Longueur (m)</label>
          <input class="input" type="number" id="voie-longueur" placeholder="Ex: 25">
        </div>
        <div class="form-group">
          <label>Description / Notes</label>
          <textarea class="input" id="voie-description" placeholder="Mouvements, style, particularit√©s..."></textarea>
        </div>
        <button class="btn btn-add btn-success" id="save-voie-btn">üíæ Enregistrer</button>
        <button class="btn delete-btn hidden" id="delete-voie-btn">üóë Supprimer cette voie</button>
      </div>
    </div>

    <!-- FALAISE: D√âTAIL VOIE + TENTATIVES -->
    <div id="voie-detail-view" class="hidden">
      <button class="back-btn" id="voie-detail-back">‚Üê Retour aux voies</button>
      <div class="card">
        <h2 id="voie-detail-title">Voie</h2>
        <div id="voie-detail-info"></div>
        <button class="btn btn-add btn-primary" id="add-tentative-btn">‚ûï Ajouter une tentative</button>
      </div>
      <div class="card">
        <h2>üìÖ Historique des tentatives</h2>
        <div id="tentatives-list"></div>
      </div>
    </div>

    <!-- FALAISE: FORMULAIRE TENTATIVE -->
    <div id="tentative-form-view" class="hidden">
      <button class="back-btn" id="tentative-form-back">‚Üê Retour</button>
      <div class="card">
        <h2 id="tentative-form-title">Nouvelle Tentative</h2>
        <input type="hidden" id="tentative-edit-id">
        <div class="form-group">
          <label>Date</label>
          <input class="input" type="date" id="tentative-date">
        </div>
        <div class="form-group">
          <label>Qui</label>
          <select class="input" id="tentative-user">
            <option value="Sophie&Bruno">Sophie&Bruno</option>
            <option value="Bruno">Bruno</option>
            <option value="Sophie">Sophie</option>
          </select>
        </div>
        <div class="form-group">
          <label>R√©sultat</label>
          <select class="input" id="tentative-resultat">
            <option value="reussi">‚úÖ R√©ussi (encha√Æn√©)</option>
            <option value="avue">‚ö° √Ä vue (1er essai)</option>
            <option value="travail">üî® Travail (en cours)</option>
            <option value="echec">‚ùå √âchec (tomb√©)</option>
          </select>
        </div>
        <div class="form-group">
          <label>Nombre d'essais</label>
          <input class="input" type="number" id="tentative-essais" value="1" min="1">
        </div>
        <div class="form-group">
          <label>Nombre de d√©gaines clipp√©es</label>
          <input class="input" type="number" id="tentative-degaines" value="0" min="0">
        </div>
        <div class="form-group">
          <label>Note (1-3 √©toiles)</label>
          <div class="stars" id="tentative-stars"></div>
          <input type="hidden" id="tentative-rating" value="0">
        </div>
        <div class="form-group">
          <label>Commentaires</label>
          <textarea class="input" id="tentative-notes" placeholder="Conditions, mouvements r√©ussis, points de progression..."></textarea>
        </div>
        <button class="btn btn-add btn-success" id="save-tentative-btn">üíæ Enregistrer</button>
        <button class="btn delete-btn hidden" id="delete-tentative-btn">üóë Supprimer cette tentative</button>
      </div>
    </div>

  </div>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, set, get, remove, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDILef-HO__QCnEJwQDNvCELmXXbF3kAfI",
  authDomain: "escalade-tracker.firebaseapp.com",
  databaseURL: "https://escalade-tracker-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "escalade-tracker",
  storageBucket: "escalade-tracker.firebasestorage.app",
  messagingSenderId: "355020489656",
  appId: "1:355020489656:web:515ba5f926045ff86f054d"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let currentUser = null;
let currentLieu = null;
let currentVoie = null;
let lieuxData = {};

// Login
document.getElementById("google-signin-btn").addEventListener('click', async () => {
  try {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({
      prompt: 'select_account'
    });
    const result = await signInWithPopup(auth, provider);
    console.log("Login successful:", result.user.email);
  } catch (error) {
    console.error("Login error:", error);
    document.getElementById("login-error").textContent = "Erreur: " + (error.message || error.code);
    document.getElementById("login-error").classList.remove("hidden");
  }
});

// Logout
document.getElementById("logout-btn").addEventListener('click', async () => {
  await signOut(auth);
  location.reload();
});

// Auth state
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    document.getElementById("login-screen").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("user-info").textContent = user.email;
    loadLieux();
  } else {
    document.getElementById("login-screen").classList.remove("hidden");
    document.getElementById("app").classList.add("hidden");
  }
});

// Navigation
function showView(viewId) {
  document.querySelectorAll('#app > .container > div').forEach(v => v.classList.add('hidden'));
  document.getElementById(viewId).classList.remove('hidden');
}

document.getElementById("board-nav").addEventListener('click', () => {
  updateStats();
  showView("board-view");
});

document.getElementById("falaise-nav").addEventListener('click', () => {
  showView("lieux-view");
  renderLieux();
});

document.getElementById("board-back").addEventListener('click', () => showView("home-view"));
document.getElementById("lieux-back").addEventListener('click', () => showView("home-view"));

// Load lieux from Firebase
function loadLieux() {
  const lieuxRef = ref(db, "lieux");
  onValue(lieuxRef, (snapshot) => {
    lieuxData = snapshot.val() || {};
    renderLieux();
  });
}

// Render lieux list
function renderLieux() {
  const list = document.getElementById("lieux-list");
  const lieux = Object.values(lieuxData);
  
  if (lieux.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="icon">üèîÔ∏è</div><p>Aucun lieu enregistr√©</p></div>';
    return;
  }
  
  list.innerHTML = lieux.map((lieu, i) => {
    const nbVoies = lieu.voies ? Object.keys(lieu.voies).length : 0;
    return `
      <div class="lieu-item" data-id="${lieu.id}" style="animation-delay:${i*0.05}s">
        <h3>${lieu.nom}</h3>
        ${lieu.region ? `<div class="lieu-stats">üìç ${lieu.region}</div>` : ''}
        <div class="lieu-stats">üßó ${nbVoies} voie${nbVoies > 1 ? 's' : ''}</div>
        <div class="item-actions">
          <button class="btn-small btn-primary edit-lieu-btn" data-id="${lieu.id}">‚úèÔ∏è Modifier</button>
          <button class="btn-small btn-secondary view-voies-btn" data-id="${lieu.id}">üëÅÔ∏è Voir les voies</button>
        </div>
      </div>
    `;
  }).join('');
  
  // Event listeners
  document.querySelectorAll('.view-voies-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const id = btn.dataset.id;
      currentLieu = lieuxData[id];
      showVoies();
    });
  });
  
  document.querySelectorAll('.edit-lieu-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      editLieu(btn.dataset.id);
    });
  });
}

// Add lieu
document.getElementById("add-lieu-btn").addEventListener('click', () => {
  document.getElementById("lieu-form-title").textContent = "Nouveau Lieu";
  document.getElementById("lieu-edit-id").value = "";
  document.getElementById("lieu-nom").value = "";
  document.getElementById("lieu-region").value = "";
  document.getElementById("lieu-notes").value = "";
  document.getElementById("delete-lieu-btn").classList.add("hidden");
  showView("lieu-form-view");
});

// Edit lieu
function editLieu(id) {
  const lieu = lieuxData[id];
  document.getElementById("lieu-form-title").textContent = "Modifier le Lieu";
  document.getElementById("lieu-edit-id").value = id;
  document.getElementById("lieu-nom").value = lieu.nom;
  document.getElementById("lieu-region").value = lieu.region || "";
  document.getElementById("lieu-notes").value = lieu.notes || "";
  document.getElementById("delete-lieu-btn").classList.remove("hidden");
  showView("lieu-form-view");
}

// Save lieu
document.getElementById("save-lieu-btn").addEventListener('click', async () => {
  const nom = document.getElementById("lieu-nom").value.trim();
  if (!nom) {
    alert("Le nom du lieu est obligatoire");
    return;
  }
  
  const id = document.getElementById("lieu-edit-id").value || Date.now().toString();
  const lieu = {
    id: id,
    nom: nom,
    region: document.getElementById("lieu-region").value.trim(),
    notes: document.getElementById("lieu-notes").value.trim(),
    voies: lieuxData[id]?.voies || {}
  };
  
  await set(ref(db, "lieux/" + id), lieu);
  showView("lieux-view");
});

// Delete lieu
document.getElementById("delete-lieu-btn").addEventListener('click', async () => {
  if (confirm("Supprimer ce lieu et toutes ses voies ?")) {
    const id = document.getElementById("lieu-edit-id").value;
    await remove(ref(db, "lieux/" + id));
    showView("lieux-view");
  }
});

document.getElementById("lieu-form-back").addEventListener('click', () => showView("lieux-view"));

// Show voies
function showVoies() {
  document.getElementById("voies-title").textContent = `üßó ${currentLieu.nom}`;
  renderVoies();
  showView("voies-view");
}

// Render voies
function renderVoies() {
  const list = document.getElementById("voies-list");
  const voies = currentLieu.voies ? Object.values(currentLieu.voies) : [];
  
  if (voies.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="icon">ü™¢</div><p>Aucune voie enregistr√©e</p></div>';
    return;
  }
  
  list.innerHTML = voies.map((voie, i) => {
    const statut = getVoieStatut(voie);
    const nbTentatives = voie.tentatives ? Object.keys(voie.tentatives).length : 0;
    return `
      <div class="voie-item" data-id="${voie.id}" style="animation-delay:${i*0.05}s">
        <h4>${voie.nom} <span class="badge badge-${statut.class}">${statut.label}</span></h4>
        <div class="voie-details">${voie.cotation} ‚Ä¢ ${voie.type} ${voie.longueur ? `‚Ä¢ ${voie.longueur}m` : ''}</div>
        <div class="voie-details">üìä ${nbTentatives} tentative${nbTentatives > 1 ? 's' : ''}</div>
        <div class="item-actions">
          <button class="btn-small btn-primary edit-voie-btn" data-id="${voie.id}">‚úèÔ∏è Modifier</button>
          <button class="btn-small btn-secondary view-detail-btn" data-id="${voie.id}">üìä D√©tails</button>
        </div>
      </div>
    `;
  }).join('');
  
  // Event listeners
  document.querySelectorAll('.edit-voie-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      editVoie(btn.dataset.id);
    });
  });
  
  document.querySelectorAll('.view-detail-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const voie = currentLieu.voies[btn.dataset.id];
      currentVoie = voie;
      showVoieDetail();
    });
  });
}

// Get voie statut
function getVoieStatut(voie) {
  if (voie.statut === 'abandonnee') {
    return {label: 'Abandonn√©e', class: 'abandonnee'};
  }
  
  const tentatives = voie.tentatives ? Object.values(voie.tentatives) : [];
  if (tentatives.length === 0) {
    return {label: '√Ä essayer', class: 'a-essayer'};
  }
  
  const hasReussi = tentatives.some(t => t.resultat === 'reussi' || t.resultat === 'avue');
  if (hasReussi) {
    return {label: 'Encha√Æn√©e', class: 'enchainee'};
  }
  
  return {label: 'Projet', class: 'projet'};
}

// Add voie
document.getElementById("add-voie-btn").addEventListener('click', () => {
  document.getElementById("voie-form-title").textContent = "Nouvelle Voie";
  document.getElementById("voie-edit-id").value = "";
  document.getElementById("voie-nom").value = "";
  document.getElementById("voie-cotation").value = "6a";
  document.getElementById("voie-type").value = "dalle";
  document.getElementById("voie-secteur").value = "";
  document.getElementById("voie-longueur").value = "";
  document.getElementById("voie-description").value = "";
  document.getElementById("delete-voie-btn").classList.add("hidden");
  showView("voie-form-view");
});

// Edit voie
function editVoie(id) {
  const voie = currentLieu.voies[id];
  document.getElementById("voie-form-title").textContent = "Modifier la Voie";
  document.getElementById("voie-edit-id").value = id;
  document.getElementById("voie-nom").value = voie.nom;
  document.getElementById("voie-cotation").value = voie.cotation;
  document.getElementById("voie-type").value = voie.type;
  document.getElementById("voie-secteur").value = voie.secteur || "";
  document.getElementById("voie-longueur").value = voie.longueur || "";
  document.getElementById("voie-description").value = voie.description || "";
  document.getElementById("delete-voie-btn").classList.remove("hidden");
  showView("voie-form-view");
}

// Save voie
document.getElementById("save-voie-btn").addEventListener('click', async () => {
  const nom = document.getElementById("voie-nom").value.trim();
  if (!nom) {
    alert("Le nom de la voie est obligatoire");
    return;
  }
  
  const id = document.getElementById("voie-edit-id").value || Date.now().toString();
  const existingVoie = currentLieu.voies?.[id] || {};
  
  const voie = {
    id: id,
    nom: nom,
    cotation: document.getElementById("voie-cotation").value,
    type: document.getElementById("voie-type").value,
    secteur: document.getElementById("voie-secteur").value.trim(),
    longueur: document.getElementById("voie-longueur").value,
    description: document.getElementById("voie-description").value.trim(),
    statut: existingVoie.statut || 'a-essayer',
    tentatives: existingVoie.tentatives || {}
  };
  
  if (!currentLieu.voies) currentLieu.voies = {};
  currentLieu.voies[id] = voie;
  
  await set(ref(db, "lieux/" + currentLieu.id), currentLieu);
  showVoies();
});

// Delete voie
document.getElementById("delete-voie-btn").addEventListener('click', async () => {
  if (confirm("Supprimer cette voie et toutes ses tentatives ?")) {
    const id = document.getElementById("voie-edit-id").value;
    delete currentLieu.voies[id];
    await set(ref(db, "lieux/" + currentLieu.id), currentLieu);
    showVoies();
  }
});

document.getElementById("voie-form-back").addEventListener('click', () => showVoies());
document.getElementById("voies-back").addEventListener('click', () => showView("lieux-view"));

// Show voie detail
function showVoieDetail() {
  const statut = getVoieStatut(currentVoie);
  document.getElementById("voie-detail-title").innerHTML = `${currentVoie.nom} <span class="badge badge-${statut.class}">${statut.label}</span>`;
  
  const info = `
    <div style="background:var(--bg-tertiary);padding:16px;border-radius:12px;margin-bottom:20px">
      <div style="margin-bottom:8px"><strong>Cotation:</strong> ${currentVoie.cotation}</div>
      <div style="margin-bottom:8px"><strong>Type:</strong> ${currentVoie.type}</div>
      ${currentVoie.secteur ? `<div style="margin-bottom:8px"><strong>Secteur:</strong> ${currentVoie.secteur}</div>` : ''}
      ${currentVoie.longueur ? `<div style="margin-bottom:8px"><strong>Longueur:</strong> ${currentVoie.longueur}m</div>` : ''}
      ${currentVoie.description ? `<div style="margin-top:12px;color:var(--text-secondary)">${currentVoie.description}</div>` : ''}
    </div>
  `;
  document.getElementById("voie-detail-info").innerHTML = info;
  
  renderTentatives();
  showView("voie-detail-view");
}

// Render tentatives
function renderTentatives() {
  const list = document.getElementById("tentatives-list");
  const tentatives = currentVoie.tentatives ? Object.values(currentVoie.tentatives).sort((a,b) => new Date(b.date) - new Date(a.date)) : [];
  
  if (tentatives.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="icon">üìù</div><p>Aucune tentative enregistr√©e</p></div>';
    return;
  }
  
  list.innerHTML = tentatives.map((t, i) => {
    const stars = '‚≠ê'.repeat(t.rating);
    return `
      <div class="tentative-item" data-id="${t.id}" style="animation-delay:${i*0.05}s">
        <h4>${new Date(t.date).toLocaleDateString('fr-FR')} <span class="badge badge-${t.resultat}">${getResultatLabel(t.resultat)}</span></h4>
        <div class="tentative-details">${t.user} ‚Ä¢ ${t.essais} essai${t.essais > 1 ? 's' : ''} ‚Ä¢ ${t.degaines} d√©gaines</div>
        ${t.rating > 0 ? `<div class="tentative-details">${stars}</div>` : ''}
        ${t.notes ? `<div style="margin-top:8px;color:var(--text-secondary);font-size:0.9rem">${t.notes}</div>` : ''}
        <div class="item-actions">
          <button class="btn-small btn-primary edit-tentative-btn" data-id="${t.id}">‚úèÔ∏è Modifier</button>
          <button class="btn-small btn-danger delete-tentative-btn" data-id="${t.id}">üóëÔ∏è</button>
        </div>
      </div>
    `;
  }).join('');
  
  // Event listeners
  document.querySelectorAll('.edit-tentative-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      editTentative(btn.dataset.id);
    });
  });
  
  document.querySelectorAll('.delete-tentative-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (confirm("Supprimer cette tentative ?")) {
        delete currentVoie.tentatives[btn.dataset.id];
        await updateVoie();
        renderTentatives();
      }
    });
  });
}

function getResultatLabel(resultat) {
  const labels = {
    'reussi': '‚úÖ R√©ussi',
    'avue': '‚ö° √Ä vue',
    'travail': 'üî® Travail',
    'echec': '‚ùå √âchec'
  };
  return labels[resultat] || resultat;
}

// Add tentative
document.getElementById("add-tentative-btn").addEventListener('click', () => {
  document.getElementById("tentative-form-title").textContent = "Nouvelle Tentative";
  document.getElementById("tentative-edit-id").value = "";
  document.getElementById("tentative-date").value = new Date().toISOString().split('T')[0];
  document.getElementById("tentative-user").value = "Sophie&Bruno";
  document.getElementById("tentative-resultat").value = "travail";
  document.getElementById("tentative-essais").value = "1";
  document.getElementById("tentative-degaines").value = "0";
  document.getElementById("tentative-rating").value = "0";
  document.getElementById("tentative-notes").value = "";
  updateStarDisplay(0);
  document.getElementById("delete-tentative-btn").classList.add("hidden");
  showView("tentative-form-view");
});

// Edit tentative
function editTentative(id) {
  const t = currentVoie.tentatives[id];
  document.getElementById("tentative-form-title").textContent = "Modifier la Tentative";
  document.getElementById("tentative-edit-id").value = id;
  document.getElementById("tentative-date").value = t.date;
  document.getElementById("tentative-user").value = t.user;
  document.getElementById("tentative-resultat").value = t.resultat;
  document.getElementById("tentative-essais").value = t.essais;
  document.getElementById("tentative-degaines").value = t.degaines;
  document.getElementById("tentative-rating").value = t.rating;
  document.getElementById("tentative-notes").value = t.notes || "";
  updateStarDisplay(t.rating);
  document.getElementById("delete-tentative-btn").classList.remove("hidden");
  showView("tentative-form-view");
}

// Stars
function updateStarDisplay(rating) {
  const container = document.getElementById("tentative-stars");
  container.innerHTML = '';
  for (let i = 1; i <= 3; i++) {
    const star = document.createElement('span');
    star.className = i <= rating ? 'star filled' : 'star empty';
    star.textContent = '‚≠ê';
    star.addEventListener('click', () => {
      document.getElementById("tentative-rating").value = i;
      updateStarDisplay(i);
    });
    container.appendChild(star);
  }
}

updateStarDisplay(0);

// Save tentative
document.getElementById("save-tentative-btn").addEventListener('click', async () => {
  const rating = parseInt(document.getElementById("tentative-rating").value);
  if (rating === 0) {
    alert("Merci de donner une note (1-3 √©toiles)");
    return;
  }
  
  const id = document.getElementById("tentative-edit-id").value || Date.now().toString();
  
  const tentative = {
    id: id,
    date: document.getElementById("tentative-date").value,
    user: document.getElementById("tentative-user").value,
    resultat: document.getElementById("tentative-resultat").value,
    essais: parseInt(document.getElementById("tentative-essais").value),
    degaines: parseInt(document.getElementById("tentative-degaines").value),
    rating: rating,
    notes: document.getElementById("tentative-notes").value.trim()
  };
  
  if (!currentVoie.tentatives) currentVoie.tentatives = {};
  currentVoie.tentatives[id] = tentative;
  
  await updateVoie();
  showVoieDetail();
});

// Delete tentative
document.getElementById("delete-tentative-btn").addEventListener('click', async () => {
  if (confirm("Supprimer cette tentative ?")) {
    const id = document.getElementById("tentative-edit-id").value;
    delete currentVoie.tentatives[id];
    await updateVoie();
    showVoieDetail();
  }
});

// Update voie in Firebase
async function updateVoie() {
  currentLieu.voies[currentVoie.id] = currentVoie;
  await set(ref(db, "lieux/" + currentLieu.id), currentLieu);
}

document.getElementById("tentative-form-back").addEventListener('click', () => showVoieDetail());
document.getElementById("voie-detail-back").addEventListener('click', () => showVoies());

// Update stats
function updateStats() {
  const lieux = Object.values(lieuxData);
  let totalVoies = 0;
  let totalEnchaines = 0;
  let totalProjets = 0;
  
  lieux.forEach(lieu => {
    if (lieu.voies) {
      const voies = Object.values(lieu.voies);
      totalVoies += voies.length;
      voies.forEach(voie => {
        const statut = getVoieStatut(voie);
        if (statut.class === 'enchainee') totalEnchaines++;
        if (statut.class === 'projet') totalProjets++;
      });
    }
  });
  
  document.getElementById("stat-lieux").textContent = lieux.length;
  document.getElementById("stat-voies").textContent = totalVoies;
  document.getElementById("stat-enchaines").textContent = totalEnchaines;
  document.getElementById("stat-projets").textContent = totalProjets;
}

</script>
</body>
</html>
